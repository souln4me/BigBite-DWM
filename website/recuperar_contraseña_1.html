<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Bite - Recuperar Contraseña</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" sizes="32x32" href="img/logo/cropped_circle_image.png">

    <style>
        body {
            background-image: url('img/local/FondoInicio.png');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Poppins', sans-serif;

            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }

        /* TARJETA */
        .card-recovery {
            background-color: #ffffff;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: none;
            overflow: hidden;
            max-width: 500px;
            width: 100%;
            margin: 20px;
            padding: 2rem;
        }

        /* INPUTS Y OJOS (Igual que Login) */
        .form-control {
            border-radius: 15px;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #212529;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background-color: #ffffff;
            border-color: #ffc107;
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2);
            color: #000;
        }

        .input-group .form-control {
            border-right: none;
            border-radius: 15px 0 0 15px;
        }

        .input-group-text {
            border-radius: 0 15px 15px 0 !important;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-left: none;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .input-group-text:hover {
            background-color: #dde0e3;
            color: #000;
        }

        /* Foco Unificado */
        .input-group:focus-within .form-control,
        .input-group:focus-within .input-group-text {
            border-color: #ffc107 !important;
        }

        .input-group:focus-within .input-group-text {
            background-color: #fff3cd;
            color: #ffc107;
        }

        .input-group:focus-within {
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2);
            border-radius: 15px;
        }

        /* BOTÓN ACCIÓN */
        .btn-action {
            background-color: #ffc107;
            color: #000;
            font-weight: 700;
            border-radius: 50px;
            padding: 12px;
            border: none;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            transition: all 0.3s;
        }

        .btn-action:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        /* UTILIDADES */
        .d-none-step {
            display: none !important;
        }

        .animate-up {
            animation: slideUpFade 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .back-link:hover {
            text-decoration: underline !important;
            color: #212529 !important;
        }
    </style>
</head>

<body>

    <div class="card card-recovery text-center animate-up">

        <div class="mb-4">
            <img src="img/logo/cropped_circle_image.png" alt="Big Bite Logo" style="width: 80px;">
        </div>

        <div id="step1-request">
            <h3 class="fw-bold mb-3">Recuperar Contraseña</h3>
            <p class="text-muted mb-4 small">Ingresa tu correo y te enviaremos un código.</p>

            <div id="alertError1"
                class="alert alert-danger d-none py-2 small fw-bold border-0 bg-danger-subtle text-danger"></div>
            <div id="alertSuccess1"
                class="alert alert-success d-none py-2 small fw-bold border-0 bg-success-subtle text-success"></div>

            <form id="formRequestToken" onsubmit="return false;">
                <div class="mb-4 text-start">
                    <label class="form-label fw-bold small text-muted ms-1">CORREO ELECTRÓNICO</label>
                    <input type="email" class="form-control" id="emailForToken" placeholder="ejemplo@correo.com"
                        required>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-action" id="btnSendToken">
                        Enviar Código <i class="bi bi-arrow-right-short"></i>
                    </button>
                </div>
            </form>
        </div>

        <div id="step2-reset" class="d-none-step animate-up">
            <h3 class="fw-bold mb-3">Nueva Contraseña</h3>
            <p class="text-muted mb-4 small">Ingresa el código que recibiste y tu nueva clave.</p>

            <div id="alertError2"
                class="alert alert-danger d-none py-2 small fw-bold border-0 bg-danger-subtle text-danger"></div>

            <form id="formResetPass" onsubmit="return false;">

                <div class="mb-3 text-start">
                    <label class="form-label fw-bold small text-muted ms-1">CÓDIGO DE VERIFICACIÓN</label>
                    <input type="text" class="form-control text-center fw-bold letter-spacing-2" id="resetToken"
                        placeholder="123456" required maxlength="100" style="letter-spacing: 2px;">
                </div>

                <div class="mb-3 text-start">
                    <label class="form-label fw-bold small text-muted ms-1">NUEVA CONTRASEÑA</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="newPassword" placeholder="Mínimo 8 caracteres">
                        <span class="input-group-text" id="toggleNew"><i class="bi bi-eye-slash"></i></span>
                    </div>
                </div>

                <div class="mb-4 text-start">
                    <label class="form-label fw-bold small text-muted ms-1">CONFIRMAR CONTRASEÑA</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="confirmPassword"
                            placeholder="Repite la contraseña">
                        <span class="input-group-text" id="toggleConfirm"><i class="bi bi-eye-slash"></i></span>
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-action" id="btnResetPassword">
                        Cambiar Contraseña
                    </button>
                </div>
            </form>
        </div>

        <div class="mt-4 pt-3 border-top">
            <a href="login.html" class="text-decoration-none text-muted small fw-bold back-link">
                <i class="bi bi-arrow-left me-1"></i> Volver al inicio de sesión
            </a>
        </div>

    </div>

    <script src="JS/config.js"></script>

    <script>
        if (typeof GRAPHQL_URL === 'undefined') {
            alert("Error Crítico: No se pudo cargar la configuración (config.js).");
            throw new Error("Falta config.js");
        }

        console.log("Conectando a:", GRAPHQL_URL);

        let userEmail = '';

        // Elementos UI
        const step1 = document.getElementById('step1-request');
        const step2 = document.getElementById('step2-reset');
        const alert1 = document.getElementById('alertError1');
        const success1 = document.getElementById('alertSuccess1');
        const alert2 = document.getElementById('alertError2');
        const btn1 = document.getElementById('btnSendToken');
        const btn2 = document.getElementById('btnResetPassword');

        // Helpers UI
        function showMsg(el, msg, isError = true) {
            el.textContent = msg;
            el.classList.remove('d-none');
            if (isError) {
                // Animación shake
                el.style.animation = 'none';
                el.offsetHeight; /* trigger reflow */
                el.style.animation = 'shake 0.3s';
            }
        }
        function hideAlerts() {
            alert1.classList.add('d-none');
            success1.classList.add('d-none');
            alert2.classList.add('d-none');
        }

        // --- PASO 1: SOLICITAR TOKEN ---
        document.getElementById('formRequestToken').addEventListener('submit', async () => {
            hideAlerts();
            const emailIn = document.getElementById('emailForToken');
            userEmail = emailIn.value.trim();

            if (!userEmail) return showMsg(alert1, "Ingresa un correo.");

            btn1.disabled = true; btn1.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Enviando...`;

            const mutation = `mutation Sol($e: String!) { solicitarRecuperacion(email: $e) { message } }`;

            try {
                const res = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: mutation, variables: { e: userEmail } })
                });
                const json = await res.json();

                if (json.errors) {
                    showMsg(alert1, json.errors[0].message);
                    btn1.disabled = false; btn1.innerHTML = `Enviar Código <i class="bi bi-arrow-right-short"></i>`;
                } else {
                    const mensajeExito = json.data.solicitarRecuperacion.message;
                    showMsg(success1, mensajeExito, false);

                    setTimeout(() => {
                        hideAlerts();
                        step1.classList.add('d-none-step');
                        step2.classList.remove('d-none-step');
                    }, 1500);
                }
            } catch (e) {
                console.error(e);
                showMsg(alert1, "Error de conexión.");
                btn1.disabled = false; btn1.innerHTML = `Enviar Código <i class="bi bi-arrow-right-short"></i>`;
            }
        });

        // --- PASO 2: RESETEAR ---
        document.getElementById('formResetPass').addEventListener('submit', async () => {
            hideAlerts();
            const token = document.getElementById('resetToken').value.trim();
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;

            if (!token || !p1) return showMsg(alert2, "Completa los campos.");
            if (p1.length < 8) return showMsg(alert2, "Mínimo 8 caracteres.");
            if (p1 !== p2) return showMsg(alert2, "Las contraseñas no coinciden.");

            btn2.disabled = true; btn2.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Guardando...`;

            const query = `
                mutation Reset($t: String!, $p: String!) {
                    resetearPassword(token: $t, nuevaPass: $p) { message }
                }
            `;

            try {
                const res = await fetch(GRAPHQL_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, variables: { t: token, p: p1 } })
                });
                const json = await res.json();

                if (json.errors) {
                    showMsg(alert2, json.errors[0].message);
                    btn2.disabled = false; btn2.textContent = "Cambiar Contraseña";
                } else {
                    // ÉXITO TOTAL -> Redirigir a pantalla final
                    window.location.href = 'recuperar_contraseña_3.html';
                }
            } catch (e) { console.error(e); showMsg(alert2, "Error de conexión."); btn2.disabled = false; btn2.textContent = "Cambiar Contraseña"; }
        });

        // --- FUNCIÓN TOGGLE PASSWORD (OJOS) ---
        function setupToggle(inputId, iconId) {
            const input = document.getElementById(inputId);
            const span = document.getElementById(iconId);
            const icon = span.querySelector('i');

            span.addEventListener('click', () => {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.replace('bi-eye-slash', 'bi-eye');
                } else {
                    input.type = 'password';
                    icon.classList.replace('bi-eye', 'bi-eye-slash');
                }
            });
        }
        setupToggle('newPassword', 'toggleNew');
        setupToggle('confirmPassword', 'toggleConfirm');

    </script>

</body>

</html>