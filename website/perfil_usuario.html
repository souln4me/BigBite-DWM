<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Big Bite - Información personal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="icon" type="image/png" sizes="32x32" href="img/logo/cropped_circle_image.png">

  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/perfil_usuario.css">
</head>

<body class="d-flex flex-column min-vh-100">

  <div id="navbar-placeholder"></div>

  <main class="flex-grow-1">
    <h1 class="text-center mb-4 mt-4">Información personal</h1>
    <hr class="mb-4">

    <div class="container">
      <div class="row">

        <div class="col-lg-8 mb-4 mt-4">
          <div class="card">
            <div class="container">
              <h5 class="mb-5">Información de la cuenta:</h5>

              <div class="row mb-4">
                <div class="col-md-4">
                  <label for="run">RUT:</label>
                  <input type="text" id="run" class="form-control" placeholder="12.345.678-9">
                </div>
                <div class="col-md-8">
                  <label for="nombre">Nombre completo:</label>
                  <input type="text" id="nombre" class="form-control" placeholder="Eduardo Vicanco Tapia">
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-6">
                  <label for="direccion">Dirección:</label>
                  <input type="text" id="direccion" class="form-control" placeholder="Calle cualquiera 123">
                </div>
                <div class="col-6">
                  <label for="region">Región:</label>
                  <select id="region" class="form-select">
                    <option value="" selected disabled>Selecciona tu región...</option>
                    <option value="arica_y_parinacota">Arica y Parinacota</option>
                    <option value="tarapaca">Tarapacá</option>
                    <option value="atacama">Atacama</option>
                    <option value="coquimbo">Coquimbo</option>
                    <option value="valparaiso">Valparaíso</option>
                    <option value="metropolitana">Metropolitana de Santiago</option>
                    <option value="ohiggins">O'Higgins</option>
                    <option value="maule">Maule</option>
                    <option value="ñuble">Ñuble</option>
                    <option value="biobio">Biobío</option>
                    <option value="araucania">Araucanía</option>
                    <option value="los_rios">Los Ríos</option>
                    <option value="los_lagos">Los Lagos</option>
                    <option value="aysen">Aysén</option>
                    <option value="magallanes">Magallanes</option>
                  </select>
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-6">
                  <label for="provincia">Provincia:</label>
                  <select id="provincia" class="form-select" disabled>
                    <option value="" selected disabled>Selecciona tu provincia...</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="comuna">Comuna:</label>
                  <select id="comuna" class="form-select" disabled>
                    <option value="" selected disabled>Selecciona tu comuna...</option>
                  </select>
                </div>
              </div>

              <div class="row mb-5">
                <div class="col-md-4">
                  <label for="fecha">Fecha de nacimiento:</label>
                  <input type="date" id="fecha" class="form-control">
                </div>
                <div class="col-md-4">
                  <label for="num">Número de teléfono:</label>
                  <input type="text" id="num" class="form-control" placeholder="9 1234 5678">
                </div>
                <div class="col-md-4">
                  <label for="sexo">Sexo:</label>
                  <select id="sexo" class="form-select">
                    <option value="" selected disabled>Seleccionar...</option>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                    <option value="otro">Otro</option>
                    <option value="no_especifica">Prefiero no decirlo</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-6 text-start">
                  <button class="btn-card-cancel">
                    <i class="bi bi-x-lg me-2"></i> Cancelar
                  </button>
                </div>
                <div class="col-6 text-end">
                  <button class="btn-card-save">
                    <i class="bi bi-floppy me-2"></i> Guardar cambios
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="col-12 col-md-4 d-flex flex-column align-items-start mt-4 mt-md-5">
          <a href="perfil_usuario.html" class="btn-perfil active">
            <i class="bi bi-person me-2"></i> Información personal
          </a>
          <a href="mis_pedidos.html" class="btn-perfil">
            <i class="bi bi-bag-check me-2"></i> Mis pedidos
          </a>
          <a href="cambiar_pass.html" class="btn-perfil">
            <i class="bi bi-key me-2"></i> Cambiar contraseña
          </a>
          <button class="btn-perfil">
            <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    // ----------------------------------------------------------------
    // --- LÓGICA PARA SELECTS DINÁMICOS (REGIÓN/PROVINCIA/COMUNA) ---
    // ----------------------------------------------------------------

    // 1. Objeto de datos
    const locationData = {
      "metropolitana": {
        "santiago": ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Santiago", "Vitacura"],
        "cordillera": ["Puente Alto", "Pirque", "San José de Maipo"],
        "maipo": ["San Bernardo", "Buin", "Calera de Tango", "Paine"],
        "talagante": ["Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"],
        "melipilla": ["Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro"],
        "chacabuco": ["Colina", "Lampa", "Tiltil"]
      },
      "valparaiso": {
        "valparaiso": ["Valparaíso", "Viña del Mar", "Concón", "Quintero", "Puchuncaví", "Casablanca", "Juan Fernández"],
        "isla_de_pascua": ["Isla de Pascua"],
        "los_andes": ["Los Andes", "San Esteban", "Calle Larga", "Rinconada"],
        "marga_marga": ["Quilpué", "Villa Alemana", "Limache", "Olmué"],
        "quillota": ["Quillota", "La Calera", "Hijuelas", "La Cruz", "Nogales"],
        "san_antonio": ["San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo"],
        "san_felipe": ["San Felipe", "Llaillay", "Putaendo", "Santa María", "Catemu", "Panquehue"],
        "petorca": ["La Ligua", "Petorca", "Cabildo", "Zapallar", "Papudo"]
      },
    };

    // 2. Seleccionar los 3 dropdowns
    const regionSelect = document.getElementById('region');
    const provinciaSelect = document.getElementById('provincia');
    const comunaSelect = document.getElementById('comuna');

    // (Tu const locationData = {...} va aquí arriba)
    // (Tu const ...Select = ... va aquí arriba)

    // Lista de palabras a mantener en minúscula (si no son la primera palabra)
    const stopWords = ['de', 'del', 'la', 'las', 'los', 'y', 'en'];

    // 3. Función para llenar Provincias (CORREGIDA)
    regionSelect.addEventListener('change', (e) => {
      const selectedRegion = e.target.value; // ej: "metropolitana"

      // Limpiar selects
      provinciaSelect.innerHTML = '<option value="" selected disabled>Selecciona tu provincia...</option>';
      comunaSelect.innerHTML = '<option value="" selected disabled>Selecciona tu comuna...</option>';

      // Habilitar/Deshabilitar
      provinciaSelect.disabled = true;
      comunaSelect.disabled = true;

      if (locationData[selectedRegion]) {
        const provincias = locationData[selectedRegion]; // Obtiene las provincias de esa región

        // Llenar el select de Provincias
        for (const provinciaKey in provincias) { // ej: "isla_de_pascua"

          // --- INICIO DE LA CORRECCIÓN ---
          const textWithSpaces = provinciaKey.replace(/_/g, ' '); // "isla de pascua"

          // Pone en mayúscula cada palabra, EXCEPTO las stopWords
          const optionText = textWithSpaces.split(' ').map((word, index) => {
            const lowerWord = word.toLowerCase();
            // Si es una stopWord Y NO es la primera palabra, mantener minúscula
            if (index > 0 && stopWords.includes(lowerWord)) {
              return lowerWord; // ej: "de"
            }
            // Si es la primera palabra O no es stopWord, capitalizar
            return word.charAt(0).toUpperCase() + word.slice(1);
          }).join(' '); // "Isla de Pascua"
          // --- FIN DE LA CORRECCIÓN ---

          const option = new Option(optionText, provinciaKey);
          provinciaSelect.add(option);
        }
        provinciaSelect.disabled = false; // Habilitar
      }
    });

    // 4. Función para llenar Comunas
    provinciaSelect.addEventListener('change', (e) => {
      const selectedRegion = regionSelect.value;
      const selectedProvincia = e.target.value; // ej: "santiago"

      // Limpiar comunas
      comunaSelect.innerHTML = '<option value="" selected disabled>Selecciona tu comuna...</option>';
      comunaSelect.disabled = true;

      if (locationData[selectedRegion] && locationData[selectedRegion][selectedProvincia]) {
        const comunas = locationData[selectedRegion][selectedProvincia]; // Obtiene el array de comunas

        // Llenar el select de Comunas
        comunas.forEach(comuna => {
          // Crea un valor amigable (ej: "cerro_navia")
          const optionValue = comuna.toLowerCase().replace(/ /g, '_');
          const option = new Option(comuna, optionValue);
          comunaSelect.add(option);
        });
        comunaSelect.disabled = false; // Habilitar
      }
    });
    // ----------------------------------------------------------------
    // --- FIN LÓGICA DE SELECTS DINÁMICOS ---
    // ----------------------------------------------------------------

    // --- Carga dinámica del Navbar ---
    fetch("components/navbar.html")
      .then(response => response.text())
      .then(data => {
        document.getElementById("navbar-placeholder").innerHTML = data;

        // --- Lógica para marcar el enlace activo en el Navbar ---
        const currentPage = window.location.pathname.split("/").pop();
        const links = document.querySelectorAll("nav a");

        links.forEach(link => {
          const href = link.getAttribute("href");
          if (!href) return;

          // Marca si la página es exacta
          if (currentPage === href.replace('./', '')) {
            link.classList.add("active");
          }

          // Caso especial: Marcar "Perfil" si estamos en cualquier subpágina de perfil
          const perfilPages = ['perfil_usuario.html', 'mis_pedidos.html', 'cambiar_pass.html'];
          if (perfilPages.includes(currentPage) && href === 'perfil_usuario.html') {
            link.classList.add("active");
          }
        });


        // --- Verificación de inicio de sesión ---
        // Redirige al login si el usuario no está logueado e intenta acceder al perfil
        const perfilLink = document.getElementById('perfil-link');
        if (perfilLink) {
          perfilLink.addEventListener('click', (e) => {
            const usuarioLogueado = localStorage.getItem('usuarioLogueado');
            if (!usuarioLogueado) {
              e.preventDefault(); // Detiene la navegación
              window.location.href = 'login.html'; // Envía al login
            }
          });
        }

        // --- Actualización del contador del carrito ---
        // Se usa un setTimeout(0) para asegurar que el DOM del navbar esté listo
        setTimeout(() => {
          const badge = document.getElementById('cart-count');
          if (!badge) return;
          const cart = JSON.parse(localStorage.getItem('carrito')) || [];
          const totalItems = cart.reduce((acc, item) => acc + (item.quantity || 1), 0);
          badge.textContent = totalItems;
        }, 0);
        // ----------------------------
      });


    // --- Carga dinámica del Footer ---
    fetch("components/footer.html")
      .then(response => response.text())
      .then(data => {
        document.getElementById("footer-placeholder").innerHTML = data;
      });

    // --- Lógica para Cerrar Sesión ---
    // Selecciona el último botón de la barra lateral (Cerrar Sesión)
    const btnCerrarSesion = document.querySelector('.btn-perfil:last-child');

    btnCerrarSesion.addEventListener('click', () => {
      // Borra el indicador de sesión del almacenamiento local
      localStorage.removeItem('usuarioLogueado');

      // Redirige al inicio
      window.location.href = 'inicio.html';
    });
  </script>
</body>

</html>