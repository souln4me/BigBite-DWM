<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Big Bite - Información personal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="icon" type="image/png" sizes="32x32" href="img/logo/cropped_circle_image.png">

  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/perfil_usuario.css">
</head>

<body class="d-flex flex-column min-vh-100">

  <div id="navbar-placeholder"></div>

  <main class="flex-grow-1">
    <h1 class="text-center mb-4 mt-4">Información personal</h1>
    <hr class="mb-4">

    <div class="container">
      <div class="row">

        <div class="col-lg-4 mt-4 mb-5">
          <div class="sticky-top" style="top: 100px; z-index: 1;">
            <a href="perfil_usuario.html" class="btn-perfil active">
              <i class="bi bi-person me-2"></i> Información personal
            </a>
            <a href="mis_pedidos.html" class="btn-perfil">
              <i class="bi bi-bag-check me-2"></i> Mis pedidos
            </a>
            <a href="cambiar_pass.html" class="btn-perfil">
              <i class="bi bi-key me-2"></i> Cambiar contraseña
            </a>
            <button class="btn-perfil" id="btn-logout-sidebar">
              <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
            </button>
          </div>
        </div>

        <div class="col-lg-8 mb-4 mt-4">
          <div class="card">

            <div class="text-center mb-4">
              <div class="profile-pic-wrapper">
                <img src="https://img.freepik.com/free-icon/user_318-159711.jpg" class="profile-pic"
                  id="userAvatarDisplay" alt="Foto de perfil">

                <div class="profile-pic-edit" title="Cambiar foto"
                  onclick="document.getElementById('inputFoto').click()">
                  <i class="bi bi-camera-fill"></i>
                </div>

                <input type="file" id="inputFoto" hidden accept="image/*">
              </div>
              <h5 class="text-white mb-0 border-0 pb-0" id="userNameDisplay">Cargando...</h5>
            </div>

            <h5 class="mb-4">
              <i class="bi bi-person-vcard me-2"></i> Datos de la cuenta
            </h5>

            <form id="formPerfil">
              <div class="row mb-4">
                <div class="col-md-4">
                  <label for="run">RUT:</label>
                  <input type="text" id="run" class="form-control" placeholder="12.345.678-9">
                </div>
                <div class="col-md-8">
                  <label for="nombre">Nombre completo:</label>
                  <input type="text" id="nombre" class="form-control" placeholder="Tu nombre">
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-6">
                  <label for="direccion">Dirección:</label>
                  <input type="text" id="direccion" class="form-control" placeholder="Calle cualquiera 123">
                </div>
                <div class="col-6">
                  <label for="region">Región:</label>
                  <select id="region" class="form-select">
                    <option value="" selected disabled>Selecciona tu región...</option>
                  </select>
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-6">
                  <label for="provincia">Provincia:</label>
                  <select id="provincia" class="form-select" disabled>
                    <option value="" selected disabled>Selecciona tu provincia...</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="comuna">Comuna:</label>
                  <select id="comuna" class="form-select" disabled>
                    <option value="" selected disabled>Selecciona tu comuna...</option>
                  </select>
                </div>
              </div>

              <div class="row mb-5">
                <div class="col-md-4">
                  <label for="fecha">Fecha de nacimiento:</label>
                  <input type="date" id="fecha" class="form-control">
                </div>
                <div class="col-md-4">
                  <label for="num">Número de teléfono:</label>
                  <input type="text" id="num" class="form-control" placeholder="9 1234 5678">
                </div>
                <div class="col-md-4">
                  <label for="sexo">Sexo:</label>
                  <select id="sexo" class="form-select">
                    <option value="" selected disabled>Seleccionar...</option>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                    <option value="otro">Otro</option>
                    <option value="no_especifica">Prefiero no decirlo</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-6 text-start">
                  <button type="button" class="btn-card-cancel">
                    <i class="bi bi-x-lg me-2"></i> Cancelar
                  </button>
                </div>
                <div class="col-6 text-end">
                  <button type="button" class="btn-card-save">
                    <i class="bi bi-floppy me-2"></i> Guardar cambios
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script src="JS/config.js"></script>
  <script src="JS/navbar-loader.js"></script>

  <script>
    let nuevaImagenBase64 = null;

    // 1. Verificar Sesión al inicio
    function verificarSesion() {
      const token = localStorage.getItem('token_bigbite');
      const usuarioData = localStorage.getItem('usuario_bigbite');

      if (!token || !usuarioData) {
        window.location.href = 'login.html';
        return null;
      }
      return JSON.parse(usuarioData);
    }

    // 2. Lógica de Ubicación
    const locationData = {
      "metropolitana": { "santiago": ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Santiago", "Vitacura"], "cordillera": ["Puente Alto", "Pirque", "San José de Maipo"], "maipo": ["San Bernardo", "Buin", "Calera de Tango", "Paine"], "talagante": ["Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"], "melipilla": ["Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro"], "chacabuco": ["Colina", "Lampa", "Tiltil"] },
      "valparaiso": { "valparaiso": ["Valparaíso", "Viña del Mar", "Concón", "Quintero", "Puchuncaví", "Casablanca", "Juan Fernández"], "isla_de_pascua": ["Isla de Pascua"], "los_andes": ["Los Andes", "San Esteban", "Calle Larga", "Rinconada"], "marga_marga": ["Quilpué", "Villa Alemana", "Limache", "Olmué"], "quillota": ["Quillota", "La Calera", "Hijuelas", "La Cruz", "Nogales"], "san_antonio": ["San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo"], "san_felipe": ["San Felipe", "Llaillay", "Putaendo", "Santa María", "Catemu", "Panquehue"], "petorca": ["La Ligua", "Petorca", "Cabildo", "Zapallar", "Papudo"] }
    };

    function initLocationLogic() {
      const regSelect = document.getElementById('region');
      const provSelect = document.getElementById('provincia');
      const comSelect = document.getElementById('comuna');

      // Limpiar y llenar
      regSelect.innerHTML = '<option value="" selected disabled>Selecciona tu región...</option>';
      for (let key in locationData) {
        let txt = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        regSelect.add(new Option(txt, key));
      }

      regSelect.addEventListener('change', (e) => {
        const sel = e.target.value;
        provSelect.innerHTML = '<option value="" selected disabled>Selecciona tu provincia...</option>';
        comSelect.innerHTML = '<option value="" selected disabled>Selecciona tu comuna...</option>';
        provSelect.disabled = true; comSelect.disabled = true;

        if (locationData[sel]) {
          for (let pKey in locationData[sel]) {
            let txt = pKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            provSelect.add(new Option(txt, pKey));
          }
          provSelect.disabled = false;
        }
      });

      provSelect.addEventListener('change', (e) => {
        const r = regSelect.value;
        const p = e.target.value;
        comSelect.innerHTML = '<option value="" selected disabled>Selecciona tu comuna...</option>';
        comSelect.disabled = true;

        if (locationData[r] && locationData[r][p]) {
          locationData[r][p].forEach(c => {
            // Normalizar valor para que coincida con DB (minuscula y guiones)
            const val = c.toLowerCase().replace(/ /g, '_');
            comSelect.add(new Option(c, val));
          });
          comSelect.disabled = false;
        }
      });
    }

    document.getElementById('inputFoto').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          alert("La imagen es muy pesada (Máx 2MB).");
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('userAvatarDisplay').src = e.target.result;
          nuevaImagenBase64 = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // 3. CARGAR DATOS (READ)
    async function cargarDatosUsuario() {
      const usuario = verificarSesion();
      const token = localStorage.getItem('token_bigbite');
      if (!usuario) return;

      initLocationLogic();

      const query = `
        query GetDatosPerfil($id: ID!) {
          getUsuarioByIdRol(id: $id) {
            rut, nombre_completo, email, telefono, direccion,
            region, provincia, comuna,
            fecha_nacimiento, sexo, img, rol { nombre }
          }
        }
      `;

      try {
        const response = await fetch(GRAPHQL_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ query: query, variables: { id: usuario.id } })
        });

        const json = await response.json();

        // Validación de respuesta
        if (json.errors) {
          console.error("GraphQL Error:", json.errors);
          alert("Error al cargar datos: " + json.errors[0].message);
          return;
        }

        const u = json.data.getUsuarioByIdRol;

        if (u) {
          // --- LLENAR CABECERA (FOTO Y NOMBRE) ---
          document.getElementById('userNameDisplay').textContent = u.nombre_completo || "Sin Nombre";
          if (u.img) {
            document.getElementById('userAvatarDisplay').src = u.img;
          }

          // --- LLENAR INPUTS ---
          if (u.rut) document.getElementById('run').value = u.rut;
          if (u.nombre_completo) document.getElementById('nombre').value = u.nombre_completo;
          if (u.direccion) document.getElementById('direccion').value = u.direccion;
          if (u.telefono) document.getElementById('num').value = u.telefono;
          if (u.sexo) document.getElementById('sexo').value = u.sexo.toLowerCase();

          // Fecha
          if (u.fecha_nacimiento) {
            let v = u.fecha_nacimiento;
            const dInput = document.getElementById('fecha');
            if (!isNaN(v) && String(v).length > 8) {
              const d = new Date(parseInt(v));
              dInput.value = d.toISOString().split('T')[0];
            } else if (v.includes('T')) {
              dInput.value = v.split('T')[0];
            } else {
              dInput.value = v;
            }
          }

          // Ubicación en Cascada
          if (u.region) {
            const regSelect = document.getElementById('region');
            regSelect.value = u.region;
            regSelect.dispatchEvent(new Event('change'));

            setTimeout(() => {
              const provSelect = document.getElementById('provincia');
              if (u.provincia) {
                provSelect.value = u.provincia;
                provSelect.dispatchEvent(new Event('change'));

                setTimeout(() => {
                  if (u.comuna) {
                    // Aseguramos formato correcto
                    const valComuna = String(u.comuna).toLowerCase().replace(/ /g, '_');
                    document.getElementById('comuna').value = valComuna;
                  }
                }, 50);
              }
            }, 50);
          }
        }
      } catch (error) {
        console.error("Error de conexión:", error);
      }
    }

    // 4. GUARDAR CAMBIOS
    async function guardarCambios() {
      const usuario = verificarSesion();
      const token = localStorage.getItem('token_bigbite');
      const btnGuardar = document.querySelector('.btn-card-save');

      // Recolectar datos
      const inputData = {
        rut: document.getElementById('run').value,
        nombre_completo: document.getElementById('nombre').value,
        direccion: document.getElementById('direccion').value,
        region: document.getElementById('region').value,
        provincia: document.getElementById('provincia').value,
        comuna: document.getElementById('comuna').value,
        fecha_nacimiento: document.getElementById('fecha').value,
        telefono: document.getElementById('num').value,
        sexo: document.getElementById('sexo').value
      };

      if (typeof nuevaImagenBase64) {
        inputData.img = nuevaImagenBase64;
      }

      // Feedback visual
      const textoOriginal = btnGuardar.innerHTML;
      btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
      btnGuardar.disabled = true;

      const mutation = `
            mutation ActualizarPerfil($id: ID!, $input: UpdateUsuarioInput) {
                updUsuario(id: $id, input: $input) {
                    id, nombre_completo, img
                }
            }
        `;

      try {
        const response = await fetch(GRAPHQL_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            query: mutation,
            variables: {
              id: usuario.id,
              input: inputData
            }
          })
        });

        const json = await response.json();

        if (json.errors) {
          alert("Error: " + json.errors[0].message);
        } else {
          alert("¡Datos actualizados correctamente!");

          // Actualizar localStorage y UI
          const uNuevo = json.data.updUsuario;
          usuario.nombre_completo = uNuevo.nombre_completo;

          // Guardar img en LocalStorage para que el navbar la use
          if (uNuevo.img) usuario.img = uNuevo.img;

          localStorage.setItem('usuario_bigbite', JSON.stringify(usuario));

          // Refrescar navbar si existe la función global
          if (window.loadNavbar) window.loadNavbar();

          // Refrescar cabecera local
          document.getElementById('userNameDisplay').textContent = uNuevo.nombre_completo || "Cliente";
          if (uNuevo.img) document.getElementById('userAvatarDisplay').src = uNuevo.img;
        }

      } catch (error) {
        console.error(error);
        alert("Error de conexión al intentar guardar.");
      } finally {
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
      }
    }

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Cargar datos
      cargarDatosUsuario();

      // 2. Botones
      const btnGuardar = document.querySelector('.btn-card-save');
      if (btnGuardar) btnGuardar.addEventListener('click', guardarCambios);

      const btnCancelar = document.querySelector('.btn-card-cancel');
      if (btnCancelar) {
        btnCancelar.addEventListener('click', () => {
          if (confirm("¿Descartar cambios?")) location.reload();
        });
      }

      // 3. LOGOUT
      const btnLogoutLateral = document.querySelector('.col-lg-4 .btn-perfil:last-child');
      if (btnLogoutLateral && btnLogoutLateral.textContent.includes("Cerrar")) {
        btnLogoutLateral.addEventListener('click', (e) => {
          e.preventDefault();
          if (confirm("¿Cerrar sesión?")) {
            localStorage.clear();
            window.location.href = 'inicio.html';
          }
        });
      }
    });
  </script>
</body>

</html>