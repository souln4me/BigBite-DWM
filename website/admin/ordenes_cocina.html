<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Bite - Monitor de Cocina</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="icon" type="image/png" sizes="32x32" href="../img/logo/cropped_circle_image.png">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/mantenedor_base.css">
</head>

<body>
    <div id="sidebar-placeholder"></div>

    <div class="main-content">
        <div class="container-fluid">
            <div class="admin-panel">

                <div class="d-flex justify-content-between align-items-center mb-4 animate-right">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="bi bi-basket text-muted me-2"> | </i> Monitor de Cocina
                        </h1>
                        <p class="text-muted mb-0 small" style="margin-left: 60px;">Gestión del flujo de preparación</p>
                    </div>
                </div>

                <div class="card card-dashboard mb-4 animate-up">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <h5 class="mb-0">Cola de Pedidos
                            <span class="badge bg-warning text-dark ms-2 rounded-pill" id="badge-count">0</span>
                        </h5>

                        <div class="d-flex gap-2 align-items-center">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="filter" id="fAll" checked>
                                <label class="btn btn-outline-secondary btn-sm rounded-start-pill px-3"
                                    for="fAll">Todos</label>

                                <input type="radio" class="btn-check" name="filter" id="fNew">
                                <label class="btn btn-outline-secondary btn-sm px-3" for="fNew">Nuevos</label>

                                <input type="radio" class="btn-check" name="filter" id="fPrep">
                                <label class="btn btn-outline-secondary btn-sm px-3" for="fPrep">En Proceso</label>

                                <input type="radio" class="btn-check" name="filter" id="fReady">
                                <label class="btn btn-outline-secondary btn-sm rounded-end-pill px-3"
                                    for="fReady">Listos</label>
                            </div>

                            <button class="btn btn-outline-primary btn-sm rounded-pill" style="padding: 8px 16px; margin-left: 20px;"
                                onclick="cargarPedidos()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body kitchen-wrapper bg-light">
                        <div class="row g-4" id="orders-grid">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-warning" role="status"></div>
                                <p class="mt-2 text-muted">Cargando despachos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4" id="orders-grid">
                </div>

            </div>
        </div>

        <div class="modal fade" id="modalTicket" tabindex="-1">
            <div class="modal-dialog modal-sm">
                <div class="modal-content border-0 bg-transparent">
                    <div class="ticket-content rounded-3">

                        <div class="ticket-header">
                            <h4 class="fw-bold mb-0">BIG BITE</h4>
                            <small>COMANDA DE COCINA</small>
                            <div class="mt-2 fw-bold fs-5" id="ticketId">#0000</div>
                            <div class="small text-muted" id="ticketFecha">--/--/-- --:--</div>
                        </div>

                        <div class="ticket-body" id="ticketItems">
                        </div>

                        <div class="ticket-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>TOTAL ITEMS:</span>
                                <span id="ticketTotalItems">0</span>
                            </div>
                            <div class="mt-3">
                                <div class="badge bg-dark text-wrap" id="ticketCliente">CLIENTE</div>
                            </div>
                        </div>

                        <div class="d-grid mt-3">
                            <button class="btn btn-sm btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../JS/config.js"></script>
    <script src="../JS/sidebar-loader.js"></script>

    <script>
        let pedidosCache = [];

        // ==========================================
        // 1. SEGURIDAD
        // ==========================================
        function initPage() {
            const token = localStorage.getItem('token_bigbite');
            if (!token) {
                window.location.href = '../login.html';
            }
        }
        initPage();

        // ==========================================
        // 3. LÓGICA BACKEND
        // ==========================================

        async function cargarPedidos() {
            const token = localStorage.getItem('token_bigbite');
            const query = `
                query {
                    getPedidos {
                        id, createdAt, estado_pedido, usuario { nombre_completo }
                        items { cantidad, producto { nombre } }
                    }
                }
            `;

            try {
                const res = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ query })
                });
                const json = await res.json();

                // Protección: si getPedidos es null, usa array vacío
                const todos = json.data.getPedidos || [];

                pedidosCache = todos.filter(p =>
                    p.estado_pedido === 'NUEVO' ||
                    p.estado_pedido === 'PAGADO' ||
                    p.estado_pedido === 'EN_PREPARACION' ||
                    p.estado_pedido === 'LISTA'
                ).sort((a, b) => Number(a.createdAt) - Number(b.createdAt));

                renderizarGrid();
            } catch (e) { console.error("Error cargando pedidos:", e); }
        }

        // Auto-refresco
        cargarPedidos();
        setInterval(cargarPedidos, 10000);

        // ==========================================
        // 4. RENDERIZADO (Aquí estaba el problema principal)
        // ==========================================

        function renderizarGrid() {
            const grid = document.getElementById('orders-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const filtroID = document.querySelector('input[name="filter"]:checked')?.id || 'fAll';

            const filtrados = pedidosCache.filter(p => {
                const est = p.estado_pedido;
                if (filtroID === 'fAll') return true;
                if (filtroID === 'fNew') return est === 'PAGADO' || est === 'NUEVO';
                if (filtroID === 'fPrep') return est === 'EN_PREPARACION';
                if (filtroID === 'fReady') return est === 'LISTA';
                return false;
            });

            const badge = document.getElementById('badge-count');
            if (badge) badge.textContent = filtrados.length;

            if (filtrados.length === 0) {
                grid.innerHTML = 
                '<div class="col-12 text-center py-5 text-muted"><h4>Todo limpio ✨</h4><small>Esperando nuevos pedidos...</small></div>';
                return;
            }

            filtrados.forEach(p => {
                // Tiempo
                let diffMins = 0;
                const val = p.createdAt;
                const timeMs = (!isNaN(val) && String(val).length > 8) ? Number(val) : new Date(val).getTime();
                if (!isNaN(timeMs)) {
                    const inicio = new Date(timeMs);
                    diffMins = Math.floor((new Date() - inicio) / 60000);
                }
                const tiempoTexto = diffMins < 1 ? "Ahora" : `${diffMins} min`;

                let cardClass = '', statusLabel = '', badgeColor = '', btnAction = '';
                const clienteNombre = p.usuario ? p.usuario.nombre_completo : "Cliente Anónimo";

                // --- ESTADOS ---
                if (p.estado_pedido === 'PAGADO' || p.estado_pedido === 'NUEVO') {
                    cardClass = 'status-new';
                    statusLabel = 'NUEVA ORDEN'; // Texto explícito
                    btnAction = `
                        <button class="btn btn-info w-100 rounded-pill py-2 fw-bold text-white shadow-sm" onclick="cambiarEstado('${p.id}', 'EN_PREPARACION')">
                            <i class="bi bi-fire me-2"></i> A Cocinar
                        </button>`;
                }
                else if (p.estado_pedido === 'EN_PREPARACION') {
                    cardClass = 'status-prep';
                    statusLabel = 'COCINANDO'; // Texto explícito
                    btnAction = `
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary w-50 rounded-pill fw-bold small" onclick="verTicket('${p.id}')"><i class="bi bi-printer"></i> Ticket</button>
                            <button class="btn btn-warning w-100 rounded-pill fw-bold text-dark shadow-sm" onclick="cambiarEstado('${p.id}', 'LISTA')">
                                <i class="bi bi-check-lg me-2"></i> ¡Listo!
                            </button>
                        </div>`;
                }
                else if (p.estado_pedido === 'LISTA') {
                    cardClass = 'status-ready';
                    statusLabel = 'LISTO PARA RETIRO'; // Texto explícito
                    btnAction = `
                        <button class="btn btn-success w-100 rounded-pill py-2 fw-bold shadow-sm" onclick="cambiarEstado('${p.id}', 'EN_DESPACHO')">
                            <i class="bi bi-box-seam me-2"></i> Entregar a Despacho
                        </button>`;
                }

                let itemsHtml = (p.items || []).map(i => `
                    <div class="k-item">
                        <div class="k-qty">${i.cantidad}</div>
                        <div class="k-item-details">
                            <div class="k-item-name">${i.producto ? i.producto.nombre : 'Producto eliminado'}</div>
                        </div>
                    </div>
                `).join('');

                const card = `
                    <div class="col-12 col-md-6 col-xl-4 animate-pop">
                        <div class="kitchen-card ${cardClass}">
                            <div class="k-card-header align-items-center">
                                <div class="d-flex flex-column">
                                    <span class="order-id" style="line-height:1;">#${p.id.slice(-4).toUpperCase()}</span>
                                    <span style="font-size: 0.75rem; text-transform: uppercase; opacity: 0.85; letter-spacing: 1px; margin-top: 4px;">
                                        ${statusLabel}
                                    </span>
                                </div>
                                <div class="order-time">
                                    <i class="bi bi-clock"></i> ${tiempoTexto}
                                </div>
                            </div>
                            
                            <div class="k-card-body">
                                <div class="mb-3 d-flex align-items-center text-muted small text-uppercase fw-bold border-bottom pb-2">
                                    <i class="bi bi-person-circle me-2"></i> ${clienteNombre}
                                </div>
                                ${itemsHtml}
                            </div>
                            <div class="k-card-footer">
                                ${btnAction}
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        window.cambiarEstado = async function (id, nuevoEstado) {
            const token = localStorage.getItem('token_bigbite');
            try {
                const res = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        query: `mutation { actualizarEstadoPedido(id: "${id}", estado: "${nuevoEstado}") { id } }`
                    })
                });
                const json = await res.json();
                if (!json.errors) cargarPedidos();
                else alert("Error: " + json.errors[0].message);
            } catch (e) { console.error(e); }
        }

        // Event Listeners para los filtros
        document.querySelectorAll('input[name="filter"]').forEach(radio => {
            radio.addEventListener('change', renderizarGrid);
        });

        // Función para abrir el Ticket
        let modalTicketBS = null;

        document.addEventListener('DOMContentLoaded', () => {
            modalTicketBS = new bootstrap.Modal(document.getElementById('modalTicket'));
        });

        function verTicket(id) {
            // Buscamos el pedido en la memoria (cache)
            const p = pedidosCache.find(x => x.id === id);
            if (!p) return;

            // Llenar datos
            document.getElementById('ticketId').textContent = "#" + p.id.slice(-4).toUpperCase();

            const fecha = new Date(Number(p.createdAt));
            document.getElementById('ticketFecha').textContent = fecha.toLocaleString('es-CL');

            const nombreCliente = p.usuario ? p.usuario.nombre_completo : "ANÓNIMO";
            document.getElementById('ticketCliente').textContent = nombreCliente.toUpperCase();

            // Llenar items
            const divItems = document.getElementById('ticketItems');
            divItems.innerHTML = '';
            let totalCount = 0;

            p.items.forEach(i => {
                totalCount += i.cantidad;
                const nombreProd = i.producto ? i.producto.nombre : 'Eliminado';

                divItems.innerHTML += `
                    <div class="row-item">
                        <span class="fw-bold">${i.cantidad} x</span>
                        <span class="text-end" style="max-width: 180px;">${nombreProd}</span>
                    </div>
                `;
            });

            document.getElementById('ticketTotalItems').textContent = totalCount;

            // Mostrar modal
            modalTicketBS.show();
        }
    </script>
</body>

</html>