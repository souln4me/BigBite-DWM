<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Bite - Mis pedidos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="icon" type="image/png" sizes="32x32" href="img/logo/cropped_circle_image.png">

    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/perfil_usuario.css">
    <link rel="stylesheet" href="css/mis_pedidos.css">
</head>

<body class="d-flex flex-column min-vh-100">

    <div id="navbar-placeholder"></div>

    <main class="flex-grow-1">
        <h1 class="text-center mb-4 mt-4">Mis pedidos</h1>
        <hr class="mb-4">

        <div class="container">
            <div class="row">

                <div class="col-lg-4 mt-4 mb-5">
                    <div class="sticky-top" style="top: 100px; z-index: 1;">
                        <a href="perfil_usuario.html" class="btn-perfil">
                            <i class="bi bi-person me-2"></i> Información personal
                        </a>
                        <a href="mis_pedidos.html" class="btn-perfil active">
                            <i class="bi bi-bag-check me-2"></i> Mis pedidos
                        </a>
                        <a href="cambiar_pass.html" class="btn-perfil">
                            <i class="bi bi-key me-2"></i> Cambiar contraseña
                        </a>
                        <button class="btn-perfil" id="btn-logout-sidebar">
                            <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
                        </button>
                    </div>
                </div>

                <div class="col-lg-8 mb-4 mt-4">
                    <div id="lista-pedidos">
                        <div class="text-center py-5">
                            <div class="spinner-border text-warning" role="status"></div>
                            <p class="mt-2 text-white-50">Cargando tu historial...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="modal fade" id="modalAnulacion" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content"
                    style="background-color: #212529; border: 1px solid rgba(255,255,255,0.1); color: #fff;">

                    <div class="modal-header border-bottom border-secondary">
                        <h5 class="modal-title fw-bold text-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> Anular Pedido
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>

                    <div class="modal-body py-4">
                        <p class="mb-3">Estás a punto de anular el pedido <strong id="lblPedidoAnular"
                                class="text-warning">#...</strong></p>
                        <p class="text-white-50 small mb-2">Por favor, indícanos el motivo:</p>

                        <div class="mb-3">
                            <select class="form-select bg-dark text-white border-secondary" id="motivoAnulacion">
                                <option value="" selected disabled>Selecciona un motivo...</option>
                                <option>Cambio de planes</option>
                                <option>Problema con el pago</option>
                                <option>Demora excesiva</option>
                                <option>Error en el pedido</option>
                                <option>Otro</option>
                            </select>
                        </div>

                        <div class="mb-0">
                            <textarea class="form-control bg-dark text-white border-secondary" id="detalleAnulacion"
                                rows="3" placeholder="Detalles adicionales (opcional)..."></textarea>
                        </div>
                    </div>

                    <div class="modal-footer border-top border-secondary">
                        <button type="button" class="btn btn-outline-light rounded-pill px-4"
                            data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold"
                            id="btnConfirmarAnulacion">
                            Confirmar Anulación
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <script src="JS/config.js"></script>
    <script src="JS/navbar-loader.js"></script>

    <script>
        const COSTO_ENVIO = 2000;
        let pedidoIdAAnular = null;
        let modalAnulacionBS = null;

        // 1. INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token_bigbite');
            if (!token) { window.location.href = 'login.html'; return; }

            modalAnulacionBS = new bootstrap.Modal(document.getElementById('modalAnulacion'));

            cargarHistorialPedidos();

            document.getElementById('btnConfirmarAnulacion').addEventListener('click', procesarAnulacion);

            // LOGOUT
            const btnLogoutLateral = document.querySelector('.col-lg-4 .btn-perfil:last-child');
            if (btnLogoutLateral && btnLogoutLateral.textContent.includes("Cerrar")) {
                btnLogoutLateral.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirm("¿Cerrar sesión?")) {
                        localStorage.clear();
                        window.location.href = 'inicio.html';
                    }
                });
            }
        });

        // 2. CARGAR DATOS
        async function cargarHistorialPedidos() {
            const token = localStorage.getItem('token_bigbite');
            const usuarioData = localStorage.getItem('usuario_bigbite');

            if (!token || !usuarioData) {
                window.location.href = 'login.html';
                return;
            }

            const usuario = JSON.parse(usuarioData);
            const query = `
                query {
                    getPedidosPorUsuario(usuarioId: "${usuario.id}") {
                        id, createdAt, total_pagado, estado_pedido
                        items { cantidad, producto { nombre } }
                    }
                }
            `;

            try {
                const res = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ query })
                });
                const json = await res.json();

                if (json.errors) throw new Error(json.errors[0].message);

                const pedidos = json.data.getPedidosPorUsuario || [];
                pedidos.sort((a, b) => Number(b.createdAt) - Number(a.createdAt));

                renderizarPedidos(pedidos);

            } catch (e) {
                console.error(e);
                document.getElementById('lista-pedidos').innerHTML = `
                    <div class="alert alert-danger bg-danger text-white border-0">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> No se pudo cargar el historial: ${e.message}
                    </div>`;
            }
        }

        function renderizarPedidos(pedidos) {
            const contenedor = document.getElementById('lista-pedidos');
            contenedor.innerHTML = '';

            if (pedidos.length === 0) {
                contenedor.innerHTML = `
                    <div class="text-center py-5 text-white-50">
                        <i class="bi bi-receipt-cutoff display-1 opacity-25"></i>
                        <h4 class="mt-4 text-white">Aún no tienes pedidos</h4>
                        <p>¡El menú te está esperando!</p>
                        <a href="productos.html" class="btn btn-warning mt-2 rounded-pill fw-bold shadow-sm px-4">Ver Menú</a>
                    </div>
                `;
                return;
            }

            pedidos.forEach(p => {
                // 1. Formato de Fecha
                let fechaTexto = "Fecha desconocida";
                if (p.createdAt) {
                    const ms = (!isNaN(p.createdAt) && String(p.createdAt).length > 8) ? Number(p.createdAt) : new Date(p.createdAt).getTime();
                    if (!isNaN(ms)) {
                        const d = new Date(ms);
                        // Ej: 5 dic, 06:31 p. m.
                        fechaTexto = d.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' }) + ', ' +
                            d.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
                    }
                }

                const totalConEnvio = p.total_pagado + COSTO_ENVIO;
                const total = totalConEnvio.toLocaleString('es-CL');

                // 2. Lista de Productos
                const itemsHtml = p.items.map(i =>
                    `<div class="item-row">
                        <span><span class="item-qty">${i.cantidad}x</span> ${i.producto ? i.producto.nombre : 'Producto eliminado'}</span>
                     </div>`
                ).join('');

                // 3. Lógica de Estado y Colores
                let statusClass = ''; // Para la barra lateral
                let statusLabel = ''; // Texto del estado
                let textClass = '';   // Color del texto del estado
                let actionBtn = '';   // Botón

                switch (p.estado_pedido) {
                    case 'NUEVO':
                    case 'PAGADO':
                        statusClass = 'status-success';
                        statusLabel = 'CONFIRMADO';
                        textClass = 'text-success';
                        actionBtn = `<button class="btn-anular-dark" onclick="abrirModalAnular('${p.id}')"><i class="bi bi-x-lg"></i> Anular</button>`;
                        break;
                    case 'PREPARANDO':
                    case 'EN_PREPARACION':
                        statusClass = 'status-warning';
                        statusLabel = 'EN PREPARACIÓN';
                        textClass = 'text-warning';
                        actionBtn = `<button class="btn-anular-dark" onclick="abrirModalAnular('${p.id}')"><i class="bi bi-x-lg"></i> Anular</button>`;
                        break;
                    case 'LISTA':
                        statusClass = 'status-info';
                        statusLabel = 'LISTO RETIRO';
                        textClass = 'text-info';
                        actionBtn = `<div class="btn-disabled-dark"><i class="bi bi-ban me-1"></i> No anulable</div>`;
                        break;
                    case 'EN_DESPACHO':
                        statusClass = 'status-info';
                        statusLabel = 'EN RUTA';
                        textClass = 'text-info';
                        actionBtn = `<div class="btn-disabled-dark"><i class="bi bi-box me-1"></i> En camino</div>`;
                        break;
                    case 'ENTREGADO':
                        statusClass = '';
                        statusLabel = 'ENTREGADO';
                        textClass = 'estado-finalizado';
                        actionBtn = `<div class="btn-disabled-dark"><i class="bi bi-check2-all"></i> Finalizado</div>`;
                        break;
                    case 'ANULADO':
                    case 'PAGO_FALLIDO':
                        statusClass = 'status-danger';
                        statusLabel = 'ANULADO';
                        textClass = 'text-danger';
                        actionBtn = `<div class="btn-disabled-dark text-danger"><i class="bi bi-x-circle"></i> Cancelado</div>`;
                        break;
                    default:
                        statusClass = ''; statusLabel = p.estado_pedido; textClass = 'text-white';
                }

                // 4. Construcción de la Tarjeta (HTML)
                const card = `
                    <div class="pedido-card ${statusClass} animate-up">
                        <div class="card-content">
                            
                            <div class="pedido-header">
                                <h5>#${p.id.slice(-6).toUpperCase()}</h5>
                                <div class="pedido-date">
                                    <i class="bi bi-calendar4-event"></i> ${fechaTexto}
                                </div>
                                <div class="mt-2">
                                    <span class="status-text ${textClass}">${statusLabel}</span>
                                </div>
                            </div>

                            <div class="pedido-items-list">
                                ${itemsHtml}
                            </div>

                            <div class="pedido-footer">
                                <div class="pedido-total">$${total}</div>
                                ${actionBtn}
                            </div>

                        </div>
                    </div>
                `;
                contenedor.innerHTML += card;
            });
        }

        // 3. PROCESO DE ANULACIÓN
        window.abrirModalAnular = function (id) {
            pedidoIdAAnular = id;
            document.getElementById('lblPedidoAnular').textContent = "#" + id.slice(-6).toUpperCase();
            document.getElementById('motivoAnulacion').value = "";
            document.getElementById('detalleAnulacion').value = "";
            modalAnulacionBS.show();
        }

        async function procesarAnulacion() {
            if (!pedidoIdAAnular) return;
            const motivo = document.getElementById('motivoAnulacion').value;
            const detalle = document.getElementById('detalleAnulacion').value.trim();

            if (!motivo) { alert('Selecciona un motivo'); return; }
            const motivoFinal = motivo + (detalle ? `: ${detalle}` : '');

            const token = localStorage.getItem('token_bigbite');
            const btn = document.getElementById('btnConfirmarAnulacion');
            const txtOrig = btn.innerHTML;

            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            try {
                const mutation = `mutation { crearAnulacionPedido(input: { pedidoId: "${pedidoIdAAnular}", motivo: "${motivoFinal}" }) { id } }`;
                const res = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ query: mutation })
                });
                const json = await res.json();

                if (json.errors) {
                    alert("Error: " + json.errors[0].message);
                } else {
                    modalAnulacionBS.hide();
                    const t = new bootstrap.Toast(document.getElementById('toastExito')); t.show();
                    cargarHistorialPedidos();
                }
            } catch (e) { console.error(e); alert("Error de conexión"); }
            finally { btn.innerHTML = txtOrig; btn.disabled = false; pedidoIdAAnular = null; }
        }
    </script>
</body>

</html>