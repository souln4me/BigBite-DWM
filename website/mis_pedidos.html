<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Bite - Mis pedidos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="icon" type="image/png" sizes="32x32" href="img/logo/icon.png">

    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/perfil_usuario.css">
    <link rel="stylesheet" href="css/mis_pedidos.css">
</head>

<body class="d-flex flex-column min-vh-100">
    <div id="navbar-placeholder"></div>

    <main class="flex-grow-1">
        <h1 class="text-center mb-4 mt-4">Mis pedidos</h1>
        <hr class="mb-4">

        <div class="container">
            <div class="row">

                <div class="col-lg-8 mb-4 mt-4">
                    <div class="pedido-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>Pedido #BGT-001</h5>
                                <p class="mb-1">Hamburguesa Clásica x2</p>
                                <p class="mb-1">Combo Papas - Bebida x1</p>
                                <p class="mb-1">Total: $42.000</p>
                                <p class="mb-1">Fecha: 15/03/2024 19:30</p>
                                <p class="mb-0 estado-anulable">Estado: Confirmado - En preparación</p>
                            </div>

                            <button class="btn btn-anular" data-bs-toggle="modal" data-bs-target="#modalAnulacion">
                                <i class="bi bi-x-lg me-2"></i> Anular pedido
                            </button>

                        </div>
                    </div>

                    <div class="pedido-card mt-4 mb-5">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>Pedido #BGT-002</h5>
                                <p class="mb-1">Hamburguesa BBQ x1</p>
                                <p class="mb-1">Papas Fritas x1</p>
                                <p class="mb-1">Total: $22.000</p>
                                <p class="mb-1">Fecha: 14/03/2024 20:15</p>
                                <p class="mb-0 estado-no-anulable">Estado: En camino - No anulable</p>
                            </div>

                            <button class="btn btn-no-anulable" id="no-anulable">
                                <i class="bi bi-ban me-2"></i> No anulable
                            </button>

                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-4 d-flex flex-column align-items-start mt-4 mt-md-5">
                    <a href="perfil_usuario.html" class="btn-perfil">
                        <i class="bi bi-person me-2"></i> Información personal
                    </a>
                    <a href="mis_pedidos.html" class="btn-perfil active"> <i class="bi bi-bag-check me-2"></i> Mis
                        pedidos
                    </a>
                    <a href="cambiar_pass.html" class="btn-perfil">
                        <i class="bi bi-key me-2"></i> Cambiar contraseña
                    </a>
                    <button class="btn-perfil">
                        <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal anulación -->
        <div class="modal fade" id="modalAnulacion" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar Anulación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Estás a punto de anular el pedido <strong>#BGT-001</strong></p>
                        <p>Por favor, indica el motivo de la anulación:</p>

                        <div class="mb-3">
                            <select class="form-select">
                                <option selected>Selecciona un motivo</option>
                                <option>Cambio de planes</option>
                                <option>Problema con el pago</option>
                                <option>Arrepentimiento de compra</option>
                                <option>Otro</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <textarea class="form-control" rows="3" placeholder="Explica en detalle..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-modal-confirm" id="confirmarAnulacion">Confirmar
                            anulación</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="toastExito" class="toast align-items-center text-bg-success border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        Orden anulada exitosamente<br>
                        <small>Se ha iniciado el proceso de reembolso</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
                </div>
            </div>

            <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        No cumple los requisitos de anulación<br>
                        <small>El pedido ya está en camino</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        // Cargar navbar
        fetch("components/navbar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("navbar-placeholder").innerHTML = data;

                // Detectar página actual y marcar enlace activo
                const currentPage = window.location.pathname.split("/").pop();
                const links = document.querySelectorAll("nav a");

                links.forEach(link => {
                    const href = link.getAttribute("href");
                    if (!href) return;

                    // Caso exacto
                    if (currentPage === href.replace('./', '')) {
                        link.classList.add("active");
                    }

                    // Caso "subpáginas de perfil"
                    const perfilPages = ['perfil_usuario.html', 'mis_pedidos.html', 'cambiar_pass.html'];
                    if (perfilPages.includes(currentPage) && href === 'perfil_usuario.html') {
                        link.classList.add("active");
                    }
                });


                // Usuario registrado
                const perfilLink = document.getElementById('perfil-link');
                if (perfilLink) {
                    perfilLink.addEventListener('click', (e) => {
                        const usuarioLogueado = localStorage.getItem('usuarioLogueado');
                        if (!usuarioLogueado) {
                            e.preventDefault();
                            window.location.href = 'register.html';
                        }
                    });
                }

                // ----------------------------
                // Aquí aseguramos que el badge del carrito se actualice
                setTimeout(() => {
                    const badge = document.getElementById('cart-count');
                    if (!badge) return;
                    const cart = JSON.parse(localStorage.getItem('carrito')) || [];
                    const totalItems = cart.reduce((acc, item) => acc + (item.quantity || 1), 0);
                    badge.textContent = totalItems;
                }, 0);
            });

        fetch("components/footer.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("footer-placeholder").innerHTML = data;
            });

        // Simulación de la anulación exitosa
        document.getElementById('confirmarAnulacion').addEventListener('click', function () {
            const motivoSelect = document.querySelector('#modalAnulacion select');
            const detalleTextarea = document.querySelector('#modalAnulacion textarea');
            const motivo = motivoSelect.value;
            const detalle = detalleTextarea.value.trim();

            // Validar que se haya elegido un motivo distinto al primero
            if (motivo === 'Selecciona un motivo' || motivo === '') {
                alert('Por favor selecciona un motivo de anulación.');
                motivoSelect.focus();
                return;
            }

            // Validar si el usuario seleccionó "Otro" y no escribió nada
            if (motivo === 'Otro' && detalle === '') {
                alert('Por favor explica el motivo de la anulación.');
                detalleTextarea.focus();
                return;
            }

            // Cerrar el modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('modalAnulacion'));
            modal.hide();

            // Mostrar mensaje de éxito
            const toast = document.getElementById('toastExito');
            toast.classList.remove('show');
            void toast.offsetWidth;
            toast.classList.add('show');
        });

        document.getElementById('no-anulable').addEventListener('click', function () {
            const toast = document.getElementById('toastError');
            toast.classList.remove('show');
            void toast.offsetWidth;
            toast.classList.add('show');
        });
    </script>
</body>

</html>